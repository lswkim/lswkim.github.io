---
title: "[FastAPI ì›¹ì„œë²„ì¸í„°í˜ì´ìŠ¤ 2] ASGI ë™ì‘ ì›ë¦¬"
date: 2025-12-28 17:00:00 +0900
categories: [Tech, FastAPI]
tags: [python, asgi, web-server, uvicorn, fastapi, websocket]
mermaid: true
---

> **ğŸ“š FastAPI ì‹œë¦¬ì¦ˆ - Part 3. ì›¹ ì„œë²„ ì¸í„°í˜ì´ìŠ¤**
>
> 1. [WSGI ë™ì‘ ì›ë¦¬](/posts/wsgi/)
> 2. ASGI ë™ì‘ ì›ë¦¬ â† í˜„ì¬ ê¸€
> 3. [Uvicorn ë‚´ë¶€ êµ¬ì¡°](/posts/uvicorn-internals/)
> 4. [Gunicorn + Uvicorn ì¡°í•© ìƒì„¸](/posts/gunicorn-uvicorn/)

---

# 2. ASGI ë™ì‘ ì›ë¦¬

## ì™œ ì´ ê°œë…ì´ ì¤‘ìš”í•œê°€?

- FastAPIëŠ” ASGI ê¸°ë°˜
- WSGIì˜ í•œê³„(ë™ê¸° ì „ìš©, WebSocket ë¶ˆê°€)ë¥¼ ê·¹ë³µ
- í˜„ëŒ€ Python ì›¹ì˜ í‘œì¤€

---

## ASGIë€?

### í•œ ì¤„ ì •ì˜

**Asynchronous Server Gateway Interface - ë¹„ë™ê¸°ë¥¼ ì§€ì›í•˜ëŠ” ì›¹ ì„œë²„ ì¸í„°í˜ì´ìŠ¤**

### WSGI vs ASGI

| í•­ëª© | WSGI | ASGI |
|:---:|:---:|:---:|
| ë™ê¸°/ë¹„ë™ê¸° | ë™ê¸°ë§Œ | **ë¹„ë™ê¸° ì§€ì›** |
| WebSocket | X | O |
| HTTP/2 | X | O |
| ì¥ì‹œê°„ ì—°ê²° | X | O |
| async/await | X | O |

---

## ASGI ì¸í„°í˜ì´ìŠ¤

### ê°€ì¥ ê°„ë‹¨í•œ ASGI ì• í”Œë¦¬ì¼€ì´ì…˜

```python
async def application(scope, receive, send):
    """
    scope: ì—°ê²° ì •ë³´ (ìš”ì²­ ë©”íƒ€ë°ì´í„°)
    receive: ë©”ì‹œì§€ ìˆ˜ì‹  ì½”ë£¨í‹´
    send: ë©”ì‹œì§€ ì†¡ì‹  ì½”ë£¨í‹´
    """
    # ì‘ë‹µ í—¤ë” ì „ì†¡
    await send({
        'type': 'http.response.start',
        'status': 200,
        'headers': [(b'content-type', b'text/plain')],
    })

    # ì‘ë‹µ ë³¸ë¬¸ ì „ì†¡
    await send({
        'type': 'http.response.body',
        'body': b'Hello, World!',
    })

```

### WSGI vs ASGI ë¹„êµ

| í•­ëª© | WSGI | ASGI |
|:---:|:---:|:---:|
| í•¨ìˆ˜ íƒ€ì… | `def` | `async def` |
| ì¸ì | `environ`, `start_response` | `scope`, `receive`, `send` |
| ë°˜í™˜ | iterable | ì—†ìŒ (sendë¡œ ì „ì†¡) |
| í†µì‹  ë°©ì‹ | ë‹¨ë°©í–¥ | **ì–‘ë°©í–¥** |

---

## í•µì‹¬ êµ¬ì„±ìš”ì†Œ

### 1. scope (ì—°ê²° ì •ë³´)

```python
# HTTP ìš”ì²­ì˜ scope ì˜ˆì‹œ
scope = {
    'type': 'http',                    # ì—°ê²° íƒ€ì…
    'asgi': {'version': '3.0'},        # ASGI ë²„ì „
    'http_version': '1.1',             # HTTP ë²„ì „
    'method': 'GET',                   # HTTP ë©”ì„œë“œ
    'path': '/users',                  # ìš”ì²­ ê²½ë¡œ
    'query_string': b'id=123',         # ì¿¼ë¦¬ ìŠ¤íŠ¸ë§
    'headers': [                       # HTTP í—¤ë”
        (b'host', b'example.com'),
        (b'user-agent', b'curl/7.68.0'),
    ],
}

# WebSocketì˜ scope
scope = {
    'type': 'websocket',               # WebSocket!
    'path': '/ws/chat',
    'headers': [...],
}

```

### 2. receive (ë©”ì‹œì§€ ìˆ˜ì‹ )

```python
async def application(scope, receive, send):
    # ìš”ì²­ ë³¸ë¬¸ ìˆ˜ì‹ 
    message = await receive()

    # message êµ¬ì¡°
    # {
    #     'type': 'http.request',
    #     'body': b'{"name": "kim"}',
    #     'more_body': False,
    # }

    body = message.get('body', b'')

```

### 3. send (ë©”ì‹œì§€ ì†¡ì‹ )

```python
async def application(scope, receive, send):
    # 1. ì‘ë‹µ ì‹œì‘ (í—¤ë”)
    await send({
        'type': 'http.response.start',
        'status': 200,
        'headers': [(b'content-type', b'application/json')],
    })

    # 2. ì‘ë‹µ ë³¸ë¬¸
    await send({
        'type': 'http.response.body',
        'body': b'{"status": "ok"}',
    })

```

---

## ìš”ì²­ ì²˜ë¦¬ íë¦„

### HTTP ìš”ì²­

```mermaid
sequenceDiagram
    participant C as í´ë¼ì´ì–¸íŠ¸
    participant S as ASGI ì„œë²„ (Uvicorn)
    participant A as ASGI ì• í”Œë¦¬ì¼€ì´ì…˜ (FastAPI)

    C->>S: HTTP ìš”ì²­
    Note over S: 1. HTTP íŒŒì‹±<br/>2. scope ë”•ì…”ë„ˆë¦¬ ìƒì„±<br/>3. receive/send ì½”ë£¨í‹´ ì¤€ë¹„

    S->>A: await application(scope, receive, send)
    Note over A: 1. scopeì—ì„œ ìš”ì²­ ì •ë³´ í™•ì¸<br/>2. body = await receive()<br/>3. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰ (async ê°€ëŠ¥!)<br/>4. await send(ì‘ë‹µ í—¤ë”)<br/>5. await send(ì‘ë‹µ ë³¸ë¬¸)

    A-->>S: ì‘ë‹µ ì™„ë£Œ
    S-->>C: HTTP ì‘ë‹µ
```

### WebSocket ì—°ê²°

```mermaid
sequenceDiagram
    participant C as í´ë¼ì´ì–¸íŠ¸
    participant S as ì„œë²„

    C->>S: WebSocket ì—°ê²° ìš”ì²­
    Note over S: scope['type'] = 'websocket'
    S-->>C: ì—°ê²° ìˆ˜ë½ (send: accept)

    C->>S: ë©”ì‹œì§€ ì „ì†¡
    Note over S: receive: message
    S-->>C: ë©”ì‹œì§€ ì‘ë‹µ (send: message)

    Note over C,S: ... ì–‘ë°©í–¥ í†µì‹  ê³„ì† ...

    C->>S: ì—°ê²° ì¢…ë£Œ

    Note over C,S: HTTPì™€ ë‹¬ë¦¬ ì—°ê²°ì´ ìœ ì§€ë˜ë©° ì–‘ë°©í–¥ í†µì‹ 
```

---

## ë©”ì‹œì§€ íƒ€ì… ì •ë¦¬

### HTTP

| ë©”ì‹œì§€ íƒ€ì… | ë°©í–¥ | ì„¤ëª… |
|:---:|:---:|:---:|
| `http.request` | receive | ìš”ì²­ ë³¸ë¬¸ |
| `http.disconnect` | receive | í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ëŠê¹€ |
| `http.response.start` | send | ì‘ë‹µ ì‹œì‘ (ìƒíƒœ, í—¤ë”) |
| `http.response.body` | send | ì‘ë‹µ ë³¸ë¬¸ |

### WebSocket

| ë©”ì‹œì§€ íƒ€ì… | ë°©í–¥ | ì„¤ëª… |
|:---:|:---:|:---:|
| `websocket.connect` | receive | ì—°ê²° ìš”ì²­ |
| `websocket.receive` | receive | ë©”ì‹œì§€ ìˆ˜ì‹  |
| `websocket.disconnect` | receive | ì—°ê²° ì¢…ë£Œ |
| `websocket.accept` | send | ì—°ê²° ìˆ˜ë½ |
| `websocket.send` | send | ë©”ì‹œì§€ ì†¡ì‹  |
| `websocket.close` | send | ì—°ê²° ì¢…ë£Œ |

---

## ì‹¤ì œ ì˜ˆì œ

### HTTP ì—ì½” ì„œë²„

```python
async def app(scope, receive, send):
    if scope['type'] != 'http':
        return

    # ìš”ì²­ ë³¸ë¬¸ ì½ê¸°
    body = b''
    while True:
        message = await receive()
        body += message.get('body', b'')
        if not message.get('more_body'):
            break

    # ì—ì½” ì‘ë‹µ
    await send({
        'type': 'http.response.start',
        'status': 200,
        'headers': [(b'content-type', b'text/plain')],
    })
    await send({
        'type': 'http.response.body',
        'body': body,  # ë°›ì€ ê·¸ëŒ€ë¡œ ë°˜í™˜
    })

```

### WebSocket ì±„íŒ…

```python
async def app(scope, receive, send):
    if scope['type'] != 'websocket':
        return

    # ì—°ê²° ìˆ˜ë½
    await send({'type': 'websocket.accept'})

    while True:
        message = await receive()

        if message['type'] == 'websocket.disconnect':
            break

        if message['type'] == 'websocket.receive':
            text = message.get('text', '')
            # ì—ì½”
            await send({
                'type': 'websocket.send',
                'text': f'Echo: {text}',
            })

```

---

## ASGIì˜ ë™ì‹œì„± ëª¨ë¸

### ì´ë²¤íŠ¸ ë£¨í”„ ê¸°ë°˜

```mermaid
graph TB
    subgraph Uvicorn["Uvicorn (ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤)"]
        EL["ì´ë²¤íŠ¸ ë£¨í”„"]
        EL --> A["ìš”ì²­ A<br/>(await I/O)"]
        EL --> B["ìš”ì²­ B<br/>(ì²˜ë¦¬ ì¤‘)"]
        EL --> C["ìš”ì²­ C<br/>(await I/O)"]
    end
    Note["ìˆ˜ì²œ ê°œ ìš”ì²­ì„ ë‹¨ì¼ ìŠ¤ë ˆë“œë¡œ ë™ì‹œ ì²˜ë¦¬ ê°€ëŠ¥"]
```

### WSGI vs ASGI ë™ì‹œì„± ë¹„êµ

| í•­ëª© | WSGI (Gunicorn) | ASGI (Uvicorn) |
|:---:|:---:|:---:|
| ë°©ì‹ | ë©€í‹° í”„ë¡œì„¸ìŠ¤/ìŠ¤ë ˆë“œ | ì´ë²¤íŠ¸ ë£¨í”„ |
| 1000 ë™ì‹œ ì—°ê²° | ì›Œì»¤ 1000ê°œ í•„ìš” | ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ ê°€ëŠ¥ |
| ë©”ëª¨ë¦¬ | ë†’ìŒ | ë‚®ìŒ |
| WebSocket | ë¶ˆê°€ | ê°€ëŠ¥ |

---

## ASGI ì„œë²„ë“¤

| ì„œë²„ | íŠ¹ì§• |
|:---:|:---:|
| **Uvicorn** | ê°€ì¥ ë„ë¦¬ ì‚¬ìš©, uvloop ì§€ì› |
| **Daphne** | Django Channelsìš©, ìµœì´ˆì˜ ASGI ì„œë²„ |
| **Hypercorn** | HTTP/2, HTTP/3 ì§€ì› |
| **Granian** | Rust ê¸°ë°˜, ê³ ì„±ëŠ¥ |

### Uvicorn ì‹¤í–‰

```bash
# ê¸°ë³¸ ì‹¤í–‰
uvicorn app:application

# ì˜µì…˜
uvicorn app:application --host 0.0.0.0 --port 8000 --workers 4

```

---

## FastAPIì™€ ASGI

### FastAPIëŠ” ASGI ì•±

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
async def root():
    return {"message": "Hello"}

# appì€ ASGI ì• í”Œë¦¬ì¼€ì´ì…˜!
# ë‚´ë¶€ì ìœ¼ë¡œ async def __call__(self, scope, receive, send) êµ¬í˜„

```

### FastAPI ë‚´ë¶€ (ë‹¨ìˆœí™”)

```python
class FastAPI:
    async def __call__(self, scope, receive, send):
        """FastAPIëŠ” ASGI callable"""
        if scope['type'] == 'http':
            # HTTP ìš”ì²­ ì²˜ë¦¬
            request = Request(scope, receive)
            response = await self.handle_request(request)
            await response(scope, receive, send)

        elif scope['type'] == 'websocket':
            # WebSocket ì²˜ë¦¬
            await self.handle_websocket(scope, receive, send)

```

---

## ASGI ë¯¸ë“¤ì›¨ì–´

### êµ¬ì¡°

```python
class SomeMiddleware:
    def __init__(self, app):
        self.app = app

    async def __call__(self, scope, receive, send):
        # ìš”ì²­ ì „ì²˜ë¦¬
        print(f"Request: {scope['path']}")

        # ë‹¤ìŒ ì•± í˜¸ì¶œ
        await self.app(scope, receive, send)

        # ì‘ë‹µ í›„ì²˜ë¦¬
        print("Response sent")

# ì ìš©
app = SomeMiddleware(original_app)

```

### FastAPIì—ì„œ ë¯¸ë“¤ì›¨ì–´

```python
from fastapi import FastAPI
from starlette.middleware.base import BaseHTTPMiddleware

app = FastAPI()

class LoggingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request, call_next):
        print(f"Request: {request.url}")
        response = await call_next(request)
        print(f"Response: {response.status_code}")
        return response

app.add_middleware(LoggingMiddleware)

```

---

## Lifespan (ìˆ˜ëª…ì£¼ê¸°)

### ì•± ì‹œì‘/ì¢…ë£Œ ì´ë²¤íŠ¸

```python
async def app(scope, receive, send):
    if scope['type'] == 'lifespan':
        while True:
            message = await receive()

            if message['type'] == 'lifespan.startup':
                # ì•± ì‹œì‘ ì‹œ ì‹¤í–‰ (DB ì—°ê²° ë“±)
                print("Starting up...")
                await send({'type': 'lifespan.startup.complete'})

            elif message['type'] == 'lifespan.shutdown':
                # ì•± ì¢…ë£Œ ì‹œ ì‹¤í–‰ (ë¦¬ì†ŒìŠ¤ ì •ë¦¬)
                print("Shutting down...")
                await send({'type': 'lifespan.shutdown.complete'})
                return

    elif scope['type'] == 'http':
        # HTTP ì²˜ë¦¬
        ...

```

### FastAPIì—ì„œ

```python
from fastapi import FastAPI
from contextlib import asynccontextmanager

@asynccontextmanager
async def lifespan(app):
    # ì‹œì‘ ì‹œ
    print("Starting up...")
    yield
    # ì¢…ë£Œ ì‹œ
    print("Shutting down...")

app = FastAPI(lifespan=lifespan)

```

---

## í•µì‹¬ ì •ë¦¬

| ê°œë… | ì„¤ëª… |
|:---:|:---:|
| **ASGI** | ë¹„ë™ê¸° ì§€ì› ì›¹ ì„œë²„ ì¸í„°í˜ì´ìŠ¤ |
| **ì¸í„°í˜ì´ìŠ¤** | `async def app(scope, receive, send)` |
| **scope** | ì—°ê²° ì •ë³´ (íƒ€ì…, ê²½ë¡œ, í—¤ë” ë“±) |
| **receive** | ë©”ì‹œì§€ ìˆ˜ì‹  ì½”ë£¨í‹´ |
| **send** | ë©”ì‹œì§€ ì†¡ì‹  ì½”ë£¨í‹´ |
| **ì§€ì› í”„ë¡œí† ì½œ** | HTTP, WebSocket, Lifespan |

### WSGI â†’ ASGI ì§„í™”

```
WSGI: ë™ê¸°, ë‹¨ë°©í–¥, HTTPë§Œ
  â†“
ASGI: ë¹„ë™ê¸°, ì–‘ë°©í–¥, HTTP + WebSocket + ë” ë§ì€ ê²ƒ

```

---